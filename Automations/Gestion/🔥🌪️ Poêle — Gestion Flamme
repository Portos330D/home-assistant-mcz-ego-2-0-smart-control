alias: ðŸ”¥ðŸŒªï¸ PoÃªle â€” Gestion Flamme + Ventilation intelligente FUSION
description: >
  Gestion intelligente fusionnÃ©e flamme + ventilation
  HystÃ©rÃ©sis anti-yoyo + Pellet + Nuit + Verrou anti-collision
  + SÃ©quence IR temporisÃ©e

triggers:
  - trigger: state
    entity_id: sensor.temperature_salon_securisee

  - trigger: state
    entity_id: sensor.niveau_pellet_vl53l0x_niveau_pellets_corrige


conditions:
  - condition: state
    entity_id: binary_sensor.poele_en_chauffe
    state: "on"

  - condition: template
    value_template: >
      {{ (as_timestamp(now())
          - as_timestamp(states.binary_sensor.poele_en_chauffe.last_changed))
          > 600 }}


actions:

  # Anti spam mÃ©moire
  - condition: template
    value_template: >
      {{ flamme_finale != flamme_memoire
         or vent_final != vent_memoire }}

  # Attente verrou libre
  - wait_template: >
      {{ is_state('input_boolean.verrou_reglage_poele','off') }}

  # Activation verrou
  - action: input_boolean.turn_on
    target:
      entity_id: input_boolean.verrou_reglage_poele

  - action: input_datetime.set_datetime
    target:
      entity_id: input_datetime.horodatage_verrou_poele
    data:
      datetime: "{{ now().strftime('%Y-%m-%d %H:%M:%S') }}"


  #########################################################
  # ðŸ”¥ RÃ‰GLAGE FLAMME
  #########################################################

  - choose:

      - conditions: "{{ flamme_finale == 5 }}"
        sequence:
          - action: script.flamme_niveau_5_max

      - conditions: "{{ flamme_finale == 4 }}"
        sequence:
          - action: script.flamme_niveau_4

      - conditions: "{{ flamme_finale == 3 }}"
        sequence:
          - action: script.flamme_niveau_3

      - conditions: "{{ flamme_finale == 2 }}"
        sequence:
          - action: script.flamme_niveau_2

      - conditions: "{{ flamme_finale == 1 }}"
        sequence:
          - action: script.flamme_niveau_1


  #########################################################
  # â³ DÃ‰LAI MENU â†’ VENTILATION
  #########################################################

  - delay: "00:00:18"


  #########################################################
  # ðŸŒªï¸ RÃ‰GLAGE VENTILATION
  #########################################################

  - choose:

      - conditions: "{{ vent_final == 5 }}"
        sequence:
          - action: script.ventilation_5

      - conditions: "{{ vent_final == 4 }}"
        sequence:
          - action: script.ventilation_4

      - conditions: "{{ vent_final == 3 }}"
        sequence:
          - action: script.ventilation_3

      - conditions: "{{ vent_final == 2 }}"
        sequence:
          - action: script.ventilation_2

      - conditions: "{{ vent_final == 1 }}"
        sequence:
          - action: script.ventilation_1


  #########################################################
  # MÃ‰MOIRE NIVEAUX
  #########################################################

  - action: input_number.set_value
    target:
      entity_id: input_number.flamme_actuelle
    data:
      value: "{{ flamme_finale }}"

  - action: input_number.set_value
    target:
      entity_id: input_number.ventilation_actuelle
    data:
      value: "{{ vent_final }}"


  #########################################################
  # LIBÃ‰RATION VERROU
  #########################################################

  - delay: "00:00:10"

  - action: input_boolean.turn_off
    target:
      entity_id: input_boolean.verrou_reglage_poele



#########################################################
# VARIABLES
#########################################################

variables:

  temp: >
    {{ states('sensor.temperature_salon_securisee') | float(21) }}

  cible: >
    {{ states('input_number.temperature_cible_poele') | float(21) }}

  ecart: "{{ cible - temp }}"

  pellet: >
    {{ states('sensor.niveau_pellet_vl53l0x_niveau_pellets_corrige')
       | float(0) }}

  heure: "{{ now().hour }}"

  nuit: "{{ heure >= 22 or heure < 6 }}"


  #########################################################
  # HYSTÃ‰RÃ‰SIS ANTI-YOYO
  #########################################################

  flamme_temp: >

    {% if ecart > 2 %}
      4
    {% elif ecart > 1 %}
      3
    {% elif ecart > 0.5 %}
      2
    {% else %}
      1
    {% endif %}


  #########################################################
  # LIMITATION PELLETS
  #########################################################

  flamme_pellet_max: >

    {% if pellet < 10 %}
      1
    {% elif pellet < 20 %}
      2
    {% elif pellet < 40 %}
      3
    {% elif pellet < 60 %}
      4
    {% else %}
      5
    {% endif %}


  #########################################################
  # MODE NUIT
  #########################################################

  flamme_nuit_max: >

    {% if nuit and is_state('input_boolean.boost_poele_actif','off') %}
      3
    {% else %}
      5
    {% endif %}


  #########################################################
  # CALCUL FINAL
  #########################################################

  flamme_finale: >
    {{ [flamme_temp,
        flamme_pellet_max,
        flamme_nuit_max] | min }}

  vent_temp: "{{ flamme_temp }}"

  vent_final: >

    {% if nuit and is_state('input_boolean.boost_poele_actif','off') %}
      {{ [vent_temp, 2] | min }}
    {% else %}
      {{ vent_temp }}
    {% endif %}


  #########################################################
  # MÃ‰MOIRES
  #########################################################

  flamme_memoire: >
    {{ states('input_number.flamme_actuelle') | int(0) }}

  vent_memoire: >
    {{ states('input_number.ventilation_actuelle') | int(0) }}


mode: single
max_exceeded: silent
